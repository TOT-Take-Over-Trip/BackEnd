<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trip.post.model.mapper.PostMapper">

  <resultMap type="postDto" id="post">
    <result column="post_id" property="postId" />
    <result column="member_id" property="memberId" />
    <result column="member_name" property="memberName" />
    <result column="title" property="title" />
    <result column="content" property="content" />
    <result column="thumbnail" property="thumbnail" />
    <result column="post_like_count" property="postLikeCount" />
    <result column="created_date" property="createdDate" />
    <result column="updated_date" property="updatedDate" />
    <result column="status" property="status" />
  </resultMap>

  <resultMap type="postResponseDto" id="postResponse">
    <result column="post_id" property="postId" />
    <result column="member_id" property="memberId" />
    <result column="member_name" property="memberName" />
    <result column="title" property="title" />
    <result column="content" property="content" />
    <result column="thumbnail" property="thumbnail" />
    <result column="post_like_count" property="postLikeCount" />
    <result column="is_like" property="isLike" />
    <result column="created_date" property="createdDate" />
    <result column="updated_date" property="updatedDate" />
    <result column="status" property="status" />
  </resultMap>
  
  <resultMap type="PostCommentDto" id="postComment">
    <result column="post_comment_id" property="postCommentId" />
    <result column="post_id" property="postId" />
    <result column="member_id" property="memberId" />
    <result column="member_name" property="memberName" />
    <result column="content" property="content" />
    <result column="created_date" property="createdDate" />
    <result column="updated_date" property="updatedDate" />
    <result column="status" property="status" />
  </resultMap>

  <select id="selectAllPosts" parameterType="int" resultMap="postResponse">
    SELECT
      p.*,
      COALESCE(pl.is_like, 0) as is_like
    FROM
      post p
        LEFT JOIN (SELECT post_id, is_like FROM post_like WHERE member_id = #{memberId}) pl ON p.post_id = pl.post_id
    where p.status= 'active';
  </select>

  <select id="selectPostById" parameterType="map" resultMap="postResponse">
    SELECT
      p.*,
      COALESCE(pl.is_like, 0) as is_like
    FROM
      post p
        LEFT JOIN (SELECT post_id, is_like FROM post_like WHERE member_id = #{memberId}) pl ON p.post_id = pl.post_id
    WHERE
      p.post_id = #{postId}
  </select>

  <select id="selectPostCommentsById" parameterType="int" resultMap="postComment">
    SELECT
      post_comment_id, post_id, member_id, member_name, content, created_date, updated_date, status
    FROM
      post_comment
    WHERE
      post_id = #{postId}
  </select>

  <select id="selectPostsByMemberId" parameterType="int" resultMap="post">
    SELECT
      post_id, member_id, member_name, title, content, thumbnail, post_like_count, created_date, updated_date, status
    FROM
      post
    WHERE status = 'active' and member_id = #{memberId}
  </select>

  <select id="selectPostsByMemberComments" parameterType="int" resultMap="post">
    SELECT DISTINCT p.post_id, p.member_id, p.member_name, p.title, p.content, p.thumbnail, p.post_like_count, p.created_date, p.updated_date, p.status
    FROM post p
           INNER JOIN post_comment pc ON p.post_id = pc.post_id
    WHERE pc.member_id = #{memberId}
  </select>

  <select id="selectPostsByMemberLike" parameterType="int" resultMap="post">
    SELECT DISTINCT p.post_id, p.member_id, p.member_name, p.title, p.content, p.thumbnail, p.post_like_count, p.created_date, p.updated_date, p.status
    FROM post p
           INNER JOIN post_like pl ON p.post_id = pl.post_id
    WHERE pl.member_id = #{memberId}
  </select>

  <insert id="insertPost" parameterType="PostDto">
    INSERT INTO Post(member_id, member_name, title, content, thumbnail)
    VALUES(#{memberId}, #{memberName}, #{title}, #{content}, #{thumbnail})
  </insert>

<!--  <insert id="insertPostComment" parameterType="PostCommentDto">-->
<!--    INSERT INTO post_comment(post_id, member_id, content, member_name)-->
<!--    VALUES(#{postId}, #{memberId},#{content}, #{memberName})-->
<!--  </insert>-->

  <insert id="insertPostComment" parameterType="PostCommentDto">
    INSERT into post_comment(post_id, member_id, content, member_name)
    VALUES (#{postId}, #{memberId}, #{content}, #{memberName})
  </insert>


  <update id="updatePost" parameterType="PostDto">
    UPDATE
      POST
    SET
      title = #{title}
      ,   content = #{content}
      ,       created_date = #{createdDate}
      ,       updated_date = #{updatedDate}
      ,       status = #{status}
    WHERE
      post_id = #{postId}
  </update>

  <update id="deletePostById" parameterType="int">
    UPDATE
      POST
    SET
      status = #{status}
    WHERE
      post_id = #{postId}
  </update>

</mapper>